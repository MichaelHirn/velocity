<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core.js - Velocity</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">

                <h1><img src="../assets/css/logo.png" title="Velocity"></h1>

        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.13</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">

                <li><a href="../classes/_symlinkPackagesDirIfPresent                                                                              // 1022.html">_symlinkPackagesDirIfPresent                                                                              // 1022</a></li>

                <li><a href="../classes/FileCopier.html">FileCopier</a></li>

                <li><a href="../classes/Meteor.methods.html">Meteor.methods</a></li>

                <li><a href="../classes/registerTestingFramework                                                                              // 153.html">registerTestingFramework                                                                              // 153</a></li>

                <li><a href="../classes/Velocity.html">Velocity</a></li>

                <li><a href="../classes/Velocity                                                                                                     // 21
/                                                                                                                    // 22
Velocity = {};                                                                                                         // 23
                                                                                                                      // 24
(function () {                                                                                                         // 25
 &#x27;use strict&#x27;;                                                                                                        // 26
                                                                                                                      // 27
//////////////////////////////////////////////////////////////////////                                                 // 28
// Init                                                                                                                // 29
//                                                                                                                     // 30
                                                                                                                      // 31
 if (process.env.NODE_ENV !== &#x27;development&#x27; ||                                                                        // 32
     process.env.VELOCITY === &#x27;0&#x27; ||                                                                                  // 33
     process.env.IS_MIRROR) {                                                                                         // 34
   DEBUG &amp;&amp; console.log(&#x27;[velocity] &#x27; + (process.env.IS_MIRROR ? &#x27;Mirror detected -&#x27; : &#x27;&#x27;) + &#x27;Not adding velocity core&#x27;);
   return;                                                                                                            // 36
 }                                                                                                                    // 37
                                                                                                                      // 38
 var getAssetPath = function (packageName, fileName) {                                                                // 39
   var serverAssetsPath = path.join(                                                                                  // 40
     findAppDir(), &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;                                        // 41
   );                                                                                                                 // 42
                                                                                                                      // 43
   packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;);                                                                       // 44
                                                                                                                      // 45
   return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);                                             // 46
 };                                                                                                                   // 47
                                                                                                                      // 48
 var _ = Npm.require(&#x27;lodash&#x27;),                                                                                       // 49
     fs = Npm.require(&#x27;fs&#x27;),                                                                                          // 50
     fse = Npm.require(&#x27;fs-extra&#x27;),                                                                                   // 51
     outputFile = Meteor.wrapAsync(fse.outputFile),                                                                   // 52
     copyFile = Meteor.wrapAsync(fse.copy),                                                                           // 53
     path = Npm.require(&#x27;path&#x27;),                                                                                      // 54
     url = Npm.require(&#x27;url&#x27;),                                                                                        // 55
     Rsync = Npm.require(&#x27;rsync&#x27;),                                                                                    // 56
     child_process = Npm.require(&#x27;child_process&#x27;),                                                                    // 57
     chokidar = Npm.require(&#x27;chokidar&#x27;),                                                                              // 58
     mkdirp = Npm.require(&#x27;mkdirp&#x27;),                                                                                  // 59
     _config = {},                                                                                                    // 60
     _preProcessors = [],                                                                                             // 61
     _postProcessors = [],                                                                                            // 62
     _watcher,                                                                                                        // 63
     FIXTURE_REG_EXP = new RegExp(&#x27;-fixture.(js|coffee)$&#x27;),                                                           // 64
     DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;),                                      // 65
     MIRROR_PID_VAR_TEMPLATE = &#x27;mirror.@PORT.pid&#x27;;                                                                    // 66
                                                                                                                      // 67
 Meteor.startup(function initializeVelocity () {                                                                      // 68
   DEBUG &amp;&amp; console.log(&#x27;[velocity] app dir&#x27;, Velocity.getAppPath());                                                 // 69
   DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));                                       // 70
                                                                                                                      // 71
   // kick-off everything                                                                                             // 72
   _reset(_config);                                                                                                   // 73
 });                                                                                                                  // 74
                                                                                                                      // 75
//////////////////////////////////////////////////////////////////////                                                 // 76
// Public Methods                                                                                                      // 77
//                                                                                                                     // 78
                                                                                                                      // 79
 _.extend(Velocity, {                                                                                                 // 80
                                                                                                                      // 81
   /**                                                                                                                // 82
Get application directory path.                                                                                 // 83
                                                                                                                // 84.html">Velocity                                                                                                     // 21
/                                                                                                                    // 22
Velocity = {};                                                                                                         // 23
                                                                                                                      // 24
(function () {                                                                                                         // 25
 &#x27;use strict&#x27;;                                                                                                        // 26
                                                                                                                      // 27
//////////////////////////////////////////////////////////////////////                                                 // 28
// Init                                                                                                                // 29
//                                                                                                                     // 30
                                                                                                                      // 31
 if (process.env.NODE_ENV !== &#x27;development&#x27; ||                                                                        // 32
     process.env.VELOCITY === &#x27;0&#x27; ||                                                                                  // 33
     process.env.IS_MIRROR) {                                                                                         // 34
   DEBUG &amp;&amp; console.log(&#x27;[velocity] &#x27; + (process.env.IS_MIRROR ? &#x27;Mirror detected -&#x27; : &#x27;&#x27;) + &#x27;Not adding velocity core&#x27;);
   return;                                                                                                            // 36
 }                                                                                                                    // 37
                                                                                                                      // 38
 var getAssetPath = function (packageName, fileName) {                                                                // 39
   var serverAssetsPath = path.join(                                                                                  // 40
     findAppDir(), &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;                                        // 41
   );                                                                                                                 // 42
                                                                                                                      // 43
   packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;);                                                                       // 44
                                                                                                                      // 45
   return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);                                             // 46
 };                                                                                                                   // 47
                                                                                                                      // 48
 var _ = Npm.require(&#x27;lodash&#x27;),                                                                                       // 49
     fs = Npm.require(&#x27;fs&#x27;),                                                                                          // 50
     fse = Npm.require(&#x27;fs-extra&#x27;),                                                                                   // 51
     outputFile = Meteor.wrapAsync(fse.outputFile),                                                                   // 52
     copyFile = Meteor.wrapAsync(fse.copy),                                                                           // 53
     path = Npm.require(&#x27;path&#x27;),                                                                                      // 54
     url = Npm.require(&#x27;url&#x27;),                                                                                        // 55
     Rsync = Npm.require(&#x27;rsync&#x27;),                                                                                    // 56
     child_process = Npm.require(&#x27;child_process&#x27;),                                                                    // 57
     chokidar = Npm.require(&#x27;chokidar&#x27;),                                                                              // 58
     mkdirp = Npm.require(&#x27;mkdirp&#x27;),                                                                                  // 59
     _config = {},                                                                                                    // 60
     _preProcessors = [],                                                                                             // 61
     _postProcessors = [],                                                                                            // 62
     _watcher,                                                                                                        // 63
     FIXTURE_REG_EXP = new RegExp(&#x27;-fixture.(js|coffee)$&#x27;),                                                           // 64
     DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;),                                      // 65
     MIRROR_PID_VAR_TEMPLATE = &#x27;mirror.@PORT.pid&#x27;;                                                                    // 66
                                                                                                                      // 67
 Meteor.startup(function initializeVelocity () {                                                                      // 68
   DEBUG &amp;&amp; console.log(&#x27;[velocity] app dir&#x27;, Velocity.getAppPath());                                                 // 69
   DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));                                       // 70
                                                                                                                      // 71
   // kick-off everything                                                                                             // 72
   _reset(_config);                                                                                                   // 73
 });                                                                                                                  // 74
                                                                                                                      // 75
//////////////////////////////////////////////////////////////////////                                                 // 76
// Public Methods                                                                                                      // 77
//                                                                                                                     // 78
                                                                                                                      // 79
 _.extend(Velocity, {                                                                                                 // 80
                                                                                                                      // 81
   /**                                                                                                                // 82
Get application directory path.                                                                                 // 83
                                                                                                                // 84</a></li>

                <li><a href="../classes/Velocity                                                                                                     // 21
/                                                                                                                    // 22
Velocity = {};                                                                                                         // 23
                                                                                                                      // 24
(function () {                                                                                                         // 25
 &#x27;use strict&#x27;;                                                                                                        // 26
                                                                                                                      // 27
//////////////////////////////////////////////////////////////////////                                                 // 28
// Init                                                                                                                // 29
//                                                                                                                     // 30
                                                                                                                      // 31
 if (process.env.NODE_ENV !== &#x27;development&#x27; ||                                                                        // 32
   process.env.VELOCITY === &#x27;0&#x27; ||                                                                                    // 33
   process.env.IS_MIRROR) {                                                                                           // 34
   DEBUG &amp;&amp; console.log(&#x27;[velocity] &#x27; + (process.env.IS_MIRROR ? &#x27;Mirror detected -&#x27; : &#x27;&#x27;) + &#x27;Not adding velocity core&#x27;);
   return;                                                                                                            // 36
 }                                                                                                                    // 37
                                                                                                                      // 38
 var getAssetPath = function (packageName, fileName) {                                                                // 39
   var serverAssetsPath = path.join(                                                                                  // 40
     findAppDir(), &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;                                        // 41
   );                                                                                                                 // 42
                                                                                                                      // 43
   packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;);                                                                       // 44
                                                                                                                      // 45
   return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);                                             // 46
 };                                                                                                                   // 47
                                                                                                                      // 48
 var _ = Npm.require(&#x27;lodash&#x27;),                                                                                       // 49
     fs = Npm.require(&#x27;fs&#x27;),                                                                                          // 50
     fse = Npm.require(&#x27;fs-extra&#x27;),                                                                                   // 51
     outputFile = Meteor.wrapAsync(fse.outputFile),                                                                   // 52
     copyFile = Meteor.wrapAsync(fse.copy),                                                                           // 53
     path = Npm.require(&#x27;path&#x27;),                                                                                      // 54
     url = Npm.require(&#x27;url&#x27;),                                                                                        // 55
     Rsync = Npm.require(&#x27;rsync&#x27;),                                                                                    // 56
     child_process = Npm.require(&#x27;child_process&#x27;),                                                                    // 57
     chokidar = Npm.require(&#x27;chokidar&#x27;),                                                                              // 58
     mkdirp = Npm.require(&#x27;mkdirp&#x27;),                                                                                  // 59
     _config = {},                                                                                                    // 60
     _preProcessors = [],                                                                                             // 61
     _postProcessors = [],                                                                                            // 62
     _watcher,                                                                                                        // 63
     FIXTURE_REG_EXP = new RegExp(&#x27;-fixture.(js|coffee)$&#x27;),                                                           // 64
     DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;),                                      // 65
     MIRROR_PID_VAR_TEMPLATE = &#x27;mirror.@PORT.pid&#x27;;                                                                    // 66
                                                                                                                      // 67
 Meteor.startup(function initializeVelocity () {                                                                      // 68
   DEBUG &amp;&amp; console.log(&#x27;[velocity] app dir&#x27;, Velocity.getAppPath());                                                 // 69
   DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));                                       // 70
                                                                                                                      // 71
   // kick-off everything                                                                                             // 72
   _reset(_config);                                                                                                   // 73
 });                                                                                                                  // 74
                                                                                                                      // 75
//////////////////////////////////////////////////////////////////////                                                 // 76
// Public Methods                                                                                                      // 77
//                                                                                                                     // 78
                                                                                                                      // 79
 _.extend(Velocity, {                                                                                                 // 80
                                                                                                                      // 81
   /**                                                                                                                // 82
Get application directory path.                                                                                 // 83
                                                                                                                // 84.html">Velocity                                                                                                     // 21
/                                                                                                                    // 22
Velocity = {};                                                                                                         // 23
                                                                                                                      // 24
(function () {                                                                                                         // 25
 &#x27;use strict&#x27;;                                                                                                        // 26
                                                                                                                      // 27
//////////////////////////////////////////////////////////////////////                                                 // 28
// Init                                                                                                                // 29
//                                                                                                                     // 30
                                                                                                                      // 31
 if (process.env.NODE_ENV !== &#x27;development&#x27; ||                                                                        // 32
   process.env.VELOCITY === &#x27;0&#x27; ||                                                                                    // 33
   process.env.IS_MIRROR) {                                                                                           // 34
   DEBUG &amp;&amp; console.log(&#x27;[velocity] &#x27; + (process.env.IS_MIRROR ? &#x27;Mirror detected -&#x27; : &#x27;&#x27;) + &#x27;Not adding velocity core&#x27;);
   return;                                                                                                            // 36
 }                                                                                                                    // 37
                                                                                                                      // 38
 var getAssetPath = function (packageName, fileName) {                                                                // 39
   var serverAssetsPath = path.join(                                                                                  // 40
     findAppDir(), &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;                                        // 41
   );                                                                                                                 // 42
                                                                                                                      // 43
   packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;);                                                                       // 44
                                                                                                                      // 45
   return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);                                             // 46
 };                                                                                                                   // 47
                                                                                                                      // 48
 var _ = Npm.require(&#x27;lodash&#x27;),                                                                                       // 49
     fs = Npm.require(&#x27;fs&#x27;),                                                                                          // 50
     fse = Npm.require(&#x27;fs-extra&#x27;),                                                                                   // 51
     outputFile = Meteor.wrapAsync(fse.outputFile),                                                                   // 52
     copyFile = Meteor.wrapAsync(fse.copy),                                                                           // 53
     path = Npm.require(&#x27;path&#x27;),                                                                                      // 54
     url = Npm.require(&#x27;url&#x27;),                                                                                        // 55
     Rsync = Npm.require(&#x27;rsync&#x27;),                                                                                    // 56
     child_process = Npm.require(&#x27;child_process&#x27;),                                                                    // 57
     chokidar = Npm.require(&#x27;chokidar&#x27;),                                                                              // 58
     mkdirp = Npm.require(&#x27;mkdirp&#x27;),                                                                                  // 59
     _config = {},                                                                                                    // 60
     _preProcessors = [],                                                                                             // 61
     _postProcessors = [],                                                                                            // 62
     _watcher,                                                                                                        // 63
     FIXTURE_REG_EXP = new RegExp(&#x27;-fixture.(js|coffee)$&#x27;),                                                           // 64
     DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;),                                      // 65
     MIRROR_PID_VAR_TEMPLATE = &#x27;mirror.@PORT.pid&#x27;;                                                                    // 66
                                                                                                                      // 67
 Meteor.startup(function initializeVelocity () {                                                                      // 68
   DEBUG &amp;&amp; console.log(&#x27;[velocity] app dir&#x27;, Velocity.getAppPath());                                                 // 69
   DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));                                       // 70
                                                                                                                      // 71
   // kick-off everything                                                                                             // 72
   _reset(_config);                                                                                                   // 73
 });                                                                                                                  // 74
                                                                                                                      // 75
//////////////////////////////////////////////////////////////////////                                                 // 76
// Public Methods                                                                                                      // 77
//                                                                                                                     // 78
                                                                                                                      // 79
 _.extend(Velocity, {                                                                                                 // 80
                                                                                                                      // 81
   /**                                                                                                                // 82
Get application directory path.                                                                                 // 83
                                                                                                                // 84</a></li>

            </ul>

            <ul id="api-modules" class="apis modules">

                <li><a href="../modules/Velocity.html">Velocity</a></li>

                <li><a href="../modules/Velocity                                                                                                    __ 10
_                                                                                                                    __ 11
_**                                                                                                                    __ 12
The &#x60;Velocity&#x60; object provides a common API for test frameworks to report                                           __ 13
test results.  Frameworks can also request assets, such as a copy of the                                            __ 14
user&#x27;s application (the &#x27;mirror&#x27;) in which tests can be safely run without                                          __ 15
impacting on-going development.                                                                                     __ 16
                                                                                                                    __ 17
Test results and log activity are reported via                                                                      __ 18
{{#crossLink &quot;Meteor.methods&quot;}}Meteor methods{{_crossLink}}.                                                        __ 19
                                                                                                                    __ 20.html">Velocity                                                                                                    // 10
/                                                                                                                    // 11
/**                                                                                                                    // 12
The &#x60;Velocity&#x60; object provides a common API for test frameworks to report                                           // 13
test results.  Frameworks can also request assets, such as a copy of the                                            // 14
user&#x27;s application (the &#x27;mirror&#x27;) in which tests can be safely run without                                          // 15
impacting on-going development.                                                                                     // 16
                                                                                                                    // 17
Test results and log activity are reported via                                                                      // 18
{{#crossLink &quot;Meteor.methods&quot;}}Meteor methods{{/crossLink}}.                                                        // 19
                                                                                                                    // 20</a></li>

            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*jshint -W117, -W030, -W016 */
/* global
 Velocity:true,
 DEBUG:true
 */

DEBUG = !!process.env.VELOCITY_DEBUG;

/**
 * @module Velocity
 */
/**
 * The &#x60;Velocity&#x60; object provides a common API for test frameworks to report
 * test results.  Frameworks can also request assets, such as a copy of the
 * user&#x27;s application (the &#x27;mirror&#x27;) in which tests can be safely run without
 * impacting on-going development.
 *
 * Test results and log activity are reported via
 * {{#crossLink &quot;Meteor.methods&quot;}}Meteor methods{{/crossLink}}.
 *
 * @class Velocity
 */
Velocity = {};

(function () {
  &#x27;use strict&#x27;;

//////////////////////////////////////////////////////////////////////
// Init
//

  if (process.env.NODE_ENV !== &#x27;development&#x27; ||
      process.env.VELOCITY === &#x27;0&#x27; ||
      process.env.IS_MIRROR) {
    DEBUG &amp;&amp; console.log(&#x27;[velocity] &#x27; + (process.env.IS_MIRROR ? &#x27;Mirror detected -&#x27; : &#x27;&#x27;) + &#x27;Not adding velocity core&#x27;);
    return;
  }

  var getAssetPath = function (packageName, fileName) {
    var serverAssetsPath = path.join(
      findAppDir(), &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;
    );

    packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;);

    return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);
  };

  var _ = Npm.require(&#x27;lodash&#x27;),
      fs = Npm.require(&#x27;fs&#x27;),
      fse = Npm.require(&#x27;fs-extra&#x27;),
      outputFile = Meteor.wrapAsync(fse.outputFile),
      copyFile = Meteor.wrapAsync(fse.copy),
      path = Npm.require(&#x27;path&#x27;),
      url = Npm.require(&#x27;url&#x27;),
      Rsync = Npm.require(&#x27;rsync&#x27;),
      child_process = Npm.require(&#x27;child_process&#x27;),
      chokidar = Npm.require(&#x27;chokidar&#x27;),
      mkdirp = Npm.require(&#x27;mkdirp&#x27;),
      _config = {},
      _preProcessors = [],
      _postProcessors = [],
      _watcher,
      FIXTURE_REG_EXP = new RegExp(&#x27;-fixture.(js|coffee)$&#x27;),
      DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;),
      MIRROR_PID_VAR_TEMPLATE = &#x27;mirror.@PORT.pid&#x27;;

  Meteor.startup(function initializeVelocity () {
    DEBUG &amp;&amp; console.log(&#x27;[velocity] app dir&#x27;, Velocity.getAppPath());
    DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));

    // kick-off everything
    _reset(_config);
  });

//////////////////////////////////////////////////////////////////////
// Public Methods
//

  _.extend(Velocity, {

    /**
     * Get application directory path.
     *
     * @method getAppPath
     * @return {String} app directory path
     */
    getAppPath: function () {
      return findAppDir();
    },

    /**
     * Get path to directory of the &#x27;mirror&#x27; application.
     *
     * @method getMirrorPath
     * @return {String} mirror directory path
     */
    getMirrorPath: function () {
      return path.join(Velocity.getAppPath(), &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;.mirror&#x27;);
    },

    /**
     * Get path to application&#x27;s &#x27;tests&#x27; directory
     *
     * @method getTestsPath
     * @return {String} application&#x27;s tests directory
     */
    getTestsPath: function () {
      return path.join(Velocity.getAppPath(), &#x27;tests&#x27;);
    },

    /**
     * Add a callback which will execute when the mirror application
     * is sync&#x27;ed up with latest application code.  Preprocessors will
     * execute before fixtures are added.
     *
     * @method addPreProcessor
     * @param {Function} preprocessor
     */
    addPreProcessor: function (preProcessor) {
      _preProcessors.push(preProcessor);
    },

    /**
     * Add a callback which will execute after all tests have completed
     * and after the aggregate test results have been reported.
     *
     * @method addPostProcessor
     * @param {Function} reporter
     */
    addPostProcessor: function (reporter) {
      _postProcessors.push(reporter);
    },

    /**
     * Get a message that displays where bugs in Velocity core itself should
     * be reported.
     *
     * @method getReportGithubIssueMessage
     * @return {String} message with bug repo url
     */
    getReportGithubIssueMessage: function () {
      return &#x27;Please report the issue here: &#x27; +
             &#x27;https://github.com/meteor-velocity/velocity/issues&#x27;;
    }
  });

  if (Meteor.isServer) {
    _.extend(Velocity, {
      /**
       * Registers a testing framework plugin.
       *
       * @method registerTestingFramework
       * @param {String} name                       The name of the testing framework.
       * @param {Object} [options]                  Options for the testing framework.
       * @param {String} options.disableAutoReset   Velocity&#x27;s reset cycle will skip reports and logs for this framework
       *                                            It will be the responsibility of the framework to clean up its ****!
       * @param {String} options.regex              The regular expression for test files that should be assigned
       *                                            to the testing framework.
       *                                            The path relative to the tests
       *                                            folder is matched against it.
       *                                            The default is &quot;name/.+\.js$&quot;
       *                                            (name is the testing framework name).
       * @param options.sampleTestGenerator {Function} sampleTestGenerator
       *    returns an array of fileObjects with the following fields:
       * @param options.sampleTestGenerator.path {String} relative path to place test file (from PROJECT/tests)
       * @param options.sampleTestGenerator.contents {String} contents of the test file the path that&#x27;s returned
       */
      registerTestingFramework: function (name, options) {
        _config[name] = _parseTestingFrameworkOptions(name, options);

        // make sure the appropriate aggregate records are added
        _reset(_config);
      }
    });
  }


//////////////////////////////////////////////////////////////////////
// Meteor Methods
//

  /**
   * Most communication with Velocity core is done via the following
   * Meteor methods.
   *
   * @class Meteor.methods
   */
  Meteor.methods({

    /**
     * Re-init file watcher and clear all test results.
     *
     * @method velocity/reset
     */
    &#x27;velocity/reset&#x27;: function () {
      _reset(_config);
    },

    /**
     * Clear all test results.
     *
     * @method velocity/reports/reset
     * @param {Object} [options]
     * @param {String} [options.framework] The name of a specific framework
     *                  to clear results for.  Ex. &#x27;jasmine&#x27; or &#x27;mocha&#x27;
     * @param {Array} [options.notIn] A list of test Ids which should be kept
     *                                (not cleared).  These Ids must match the
     *                                ones passed to &#x60;velocity/reports/submit&#x60;.
     */
    &#x27;velocity/reports/reset&#x27;: function (options) {
      options = options || {};
      check(options, {
        framework: Match.Optional(String),
        notIn: Match.Optional([String])
      });

      var query = {};
      if (options.framework) {
        query.framework = options.framework;
      }
      if (options.notIn) {
        query = _.assign(query, {_id: {$nin: options.notIn}});
      }
      VelocityTestReports.remove(query);
      _updateAggregateReports();
    },


    /**
     * Clear all log entries.
     *
     * @method velocity/logs/reset
     * @param {Object} [options]
     * @param {String} [options.framework] The name of a specific framework
     *                                     to clear logs for.
     */
    &#x27;velocity/logs/reset&#x27;: function (options) {
      options = options || {};
      check(options, {
        framework: Match.Optional(String)
      });

      var query = {};
      if (options.framework) {
        query.framework = options.framework;
      }
      VelocityLogs.remove(query);
    },


    /**
     * Log a message to the Velocity log store.  This provides a central
     * location for different reporters to query for test framework log
     * entries.
     *
     * @method velocity/logs/submit
     * @param {Object} options
     * @param {String} options.framework The name of the test framework
     * @param {String} options.message The message to log
     * @param {String} [options.level] Log level.  Ex. &#x27;error&#x27;. Default: &#x27;info&#x27;
     * @param {Date} [options.timestamp]
     */
    &#x27;velocity/logs/submit&#x27;: function (options) {
      check(options, {
        framework: String,
        message: String,
        level: Match.Optional(String),
        timestamp: Match.Optional(Match.OneOf(Date, String))
      });

      VelocityLogs.insert({
        timestamp: options.timestamp || new Date(),
        level: options.level || &#x27;info&#x27;,
        message: options.message,
        framework: options.framework
      });
    },


    /**
     * Record the results of an individual test run; a simple collector of
     * test data.
     *
     * The &#x60;data&#x60; object is stored in its entirety; any field may be passed in.
     * The optional fields documented here are suggestions based on what the
     * standard html-reporter supports.  Whether or not a field is actually
     * used is up to the specific test reporter that the user has installed.
     *
     * @method velocity/reports/submit
     * @param {Object} data
     * @param {String} data.name Name of the test that was executed.
     * @param {String} data.framework Name of a testing framework.
     *                                For example, &#x27;jasmine&#x27; or &#x27;mocha&#x27;.
     * @param {String} data.result The results of the test.  Standard values
     *                             are &#x27;passed&#x27; and &#x27;failed&#x27;.  Different test
     *                             reporters can support other values.  For
     *                             example, the aggregate tests collection uses
     *                             &#x27;pending&#x27; to indicate that results are still
     *                             coming in.
     * @param {String} [data.id] Used to update a specific test result.  If not
     *                           provided, frameworks can use the
     *                           &#x60;velocity/reports/reset&#x60; Meteor method to
     *                           clear all tests.
     * @param {Array} [data.ancestors] The hierarchy of suites and blocks above
     *                                 this test. For example,
     *                              [&#x27;Template&#x27;, &#x27;leaderboard&#x27;, &#x27;selected_name&#x27;]
     * @param {Date} [data.timestamp] The time that the test started for this
     *                                result.
     * @param {Number} [data.duration] The test duration in milliseconds.
     * @param {String} [data.browser] Which browser did the test run in?
     * @param {String} [data.failureType] For example, &#x27;expect&#x27; or &#x27;assert&#x27;
     * @param {String} [data.failureMessage]
     * @param {String} [data.failureStackTrace] The stack trace associated with
     *                                          the failure
     */
    &#x27;velocity/reports/submit&#x27;: function (data) {
      check(data, Match.ObjectIncluding({
        name: String,
        framework: String,
        result: String,
        id: Match.Optional(String),
        ancestors: Match.Optional([String]),
        timestamp: Match.Optional(Match.OneOf(Date, String)),
        duration: Match.Optional(Number),
        browser: Match.Optional(String),
        failureType: Match.Optional(String),
        failureMessage: Match.Optional(String),
        failureStackTrace: Match.Optional(Match.Any)
      }));

      data.timestamp = data.timestamp || new Date();
      data.id = data.id || Random.id();

      VelocityTestReports.upsert(data.id, {$set: data});

      _updateAggregateReports();
    },  // end postResult


    /**
     * Frameworks must call this method to inform Velocity they have completed
     * their current test runs. Velocity uses this flag when running in CI mode.
     *
     * @method velocity/reports/completed
     * @param {Object} data
     * @param {String} data.framework Name of a test framework.  Ex. &#x27;jasmine&#x27;
     */
    &#x27;velocity/reports/completed&#x27;: function (data) {
      check(data, {
        framework: String
      });

      VelocityAggregateReports.upsert({&#x27;name&#x27;: data.framework},
                                      {$set: {&#x27;result&#x27;: &#x27;completed&#x27;}});
      _updateAggregateReports();
    },  // end completed


    /**
     * Copy sample tests from frameworks &#x60;sample-tests&#x60; directories
     * to the user&#x27;s application&#x27;s &#x60;tests&#x60; directory.
     *
     * @method velocity/copySampleTests
     *
     * @param {Object} options
     * @param {String} options.framework Framework name. Ex. &#x27;jasmine&#x27;, &#x27;mocha&#x27;
     */
    &#x27;velocity/copySampleTests&#x27;: function (options) {
      var sampleTests,
          samplesPath,
          testsPath,
          command;

      options = options || {};
      check(options, {
        framework: String
      });

      if (_config[options.framework].sampleTestGenerator) {

        sampleTests = _config[options.framework].sampleTestGenerator(options);

        DEBUG &amp;&amp; console.log(&#x27;[velocity] found &#x27;, sampleTests.length,
                             &#x27;sample test files for&#x27;, options.framework);

        sampleTests.forEach(function (testFile) {
          var fullTestPath = path.join(Velocity.getTestsPath(), testFile.path);
          var testDir = path.dirname(fullTestPath);
          mkdirp.sync(testDir);
          fs.writeFileSync(fullTestPath, testFile.contents);
        });

      } else {

        samplesPath = path.join(Velocity.getAppPath(), &#x27;packages&#x27;,
                                options.framework, &#x27;sample-tests&#x27;);
        testsPath = Velocity.getTestsPath();

        DEBUG &amp;&amp; console.log(&#x27;[velocity] checking for sample tests in&#x27;,
                              path.join(samplesPath, &#x27;*&#x27;));

        if (fs.existsSync(samplesPath)) {
          command = &#x27;mkdir -p &#x27; + testsPath + &#x27; &amp;&amp; &#x27; +
                    &#x27;rsync -au &#x27; + path.join(samplesPath, &#x27;*&#x27;) +
                    &#x27; &#x27; + testsPath + path.sep;

          DEBUG &amp;&amp; console.log(&#x27;[velocity] copying sample tests (if any) &#x27; +
                               &#x27;for framework&#x27;, options.framework, &#x27;-&#x27;,
                               command);

          child_process.exec(command, Meteor.bindEnvironment(
            function copySampleTestsExecHandler (err, stdout, stderr) {
              if (err) {
                console.error(&#x27;ERROR&#x27;, err);
              }
              console.log(stdout);
              console.error(stderr);
            },
            &#x27;copySampleTestsExecHandler&#x27;
          ));
        }

      }
    },  // end copySampleTests


    /**
     * Starts a new mirror if it has not already been started, and reuses an
     * existing one if it is already started.
     *
     * This method will update the &#x60;VelocityMirrors&#x60; collection with &#x60;requestId&#x60;
     * once the mirror is ready for use.
     *
     * @method velocity/mirrors/request
     *
     * @param {Object} options                  Options for the mirror.
     * @param {String} options.framework        The name of the calling framework
     * @param {String} [options.fixtureFiles]   Array of files with absolute paths
     * @param {String} [options.port]           String use a specific port
     * @param {String} [options.requestId]      Id for the mirror that may be used to query the mirror for status info
     * @param {String} [options.rootUrlPath]    Adds this string to the end of the root url in the VelocityMirrors collection.
     *                                          eg. &#x60;/?jasmine=true&#x60;
     *                                          Request parameters that velocity-ci uses.
     *
     * @return {String} The &#x60;requestId&#x60; that can be used to query the mirror
     */
    &#x27;velocity/mirrors/request&#x27;: function (options) {
      check(options, {
        framework: String,
        port: Match.Optional(Number),
        fixtureFiles: Match.Optional([String]),
        requestId: Match.Optional(String),
        rootUrlPath: Match.Optional(String)
      });
      options.port = options.port || 5000;
      options.requestId = options.requestId || Random.id();

      var rootUrlPath = (options.rootUrlPath || &#x27;&#x27;).replace(/\//, &#x27;&#x27;);
      options.rootUrl = _getMirrorUrl(options.port) + rootUrlPath;

      DEBUG &amp;&amp; console.log(&#x27;[velocity] Mirror requested&#x27;, options,
                           &#x27;requestId:&#x27;, options.requestId);


      var connectToMirrorViaDDP = function () {
        DEBUG &amp;&amp; console.log(&#x27;[velocity] Connecting to mirror via DDP...&#x27;);
        var ddpConnection = DDP.connect(options.rootUrl);
        ddpConnection.onReconnect = function () {
          DEBUG &amp;&amp; console.log(&#x27;[velocity] Connected, updating mirror metadata&#x27;);
          _updateMirrorMetadata(options);
          this.disconnect();
        };
      };

      DEBUG &amp;&amp; console.log(&#x27;[velocity] Checking if requested mirror is already started.&#x27;);
      if (!_isProcessRunningForRegisteredMirrorPid(options.port)) {
        DEBUG &amp;&amp; console.log(&#x27;[velocity] Requested mirror not started. Starting...&#x27;);
        _velocityStartMirror(options, function () {
          connectToMirrorViaDDP();
        });
      } else {
        DEBUG &amp;&amp; console.log(&#x27;[velocity] Requested mirror pid already running. Reusing...&#x27;);
        connectToMirrorViaDDP();
      }

      return options.requestId;
    },


    /**
     * Exposes the IS_MIRROR flag to clients
     *
     * @method velocity/isMirror
     * @return {Boolean} true if currently running in mirror
     */
    &#x27;velocity/isMirror&#x27;: function () {
      return !!process.env.IS_MIRROR;
    },

    /**
     * Syncs the mirror filesystem on an adhoc basis.
     * Used by the core when file changes are detected.
     *
     * @method velocity/syncMirror
     */
    &#x27;velocity/syncMirror&#x27;: function () {
      _syncMirror();
    }

  });  // end Meteor methods




//////////////////////////////////////////////////////////////////////
// Private functions
//


  /**
   * Starts a mirror and copies any specified fixture files into the mirror.
   *
   * @method velocityStartMirror
   * @param {Object} options Required fields:
   *                   framework - String ex. &#x27;mocha-web-1&#x27;
   *                   rootUrl - String ex. &#x27;http://localhost:5000/x=y&#x27;
   *
   *                 Optional parameters:
   *                   fixtureFiles - Array of files with absolute paths
   *                   port - String use a specific port instead of finding the next available one
   *                   next - function to call after the mirror has started
   *
   * @private
   */
  function _velocityStartMirror (options, next) {

    // perform a forced rsync as we are about to start a mirror
    _syncMirror(true);

    var port = options.port;
    var mongoLocation = _getMongoUrl(options.framework);
    var mirrorLocation = _getMirrorUrl(port);

    if (options.fixtureFiles) {
      _addFixtures(options.fixtureFiles);
    }

    var opts = {
      cwd: Velocity.getMirrorPath(),
      stdio: &#x27;pipe&#x27;,
      env: _.extend({}, process.env, {
        ROOT_URL: mirrorLocation,
        MONGO_URL: mongoLocation,
        PARENT_URL: process.env.ROOT_URL,
        IS_MIRROR: true
      })
    };

    var settingsPath = path.join(Velocity.getMirrorPath(), &#x27;settings.json&#x27;);
    outputFile(settingsPath, JSON.stringify(Meteor.settings));

    console.log(&#x27;[velocity] Starting mirror at&#x27;, mirrorLocation);

    _startMeteor(port, settingsPath, opts, function () {
      // do another forced sync in case the user changes any files whilst the mirror is starting up
      _syncMirror(true);
      next();
    });

  } // end velocityStartMirror

  /**
   * Updated the VelocityMirrors collection with metadata about a newly started or reused mirror
   *
   * @method _updateMirrorMetadata
   * @param {Object} options Required fields:
   *                   framework - String ex. &#x27;mocha-web-1&#x27;
   *                   port - String the port the mirror that just started / was reused is using
   *                   requestId - the request id to put in the mirror metadata
   *
   * @private
   */
  function _updateMirrorMetadata (options) {
    // if this is a request we&#x27;ve seen before
    var existingMirror = VelocityMirrors.findOne({
      framework: options.framework,
      port: options.port
    });
    if (existingMirror) {
      // if we already have this mirror metadata, update it
      VelocityMirrors.update(existingMirror._id, {$set: {requestId: options.requestId}});
    } else {
      // if this is a request we haven&#x27;t seen before, create a new metadata entry
      VelocityMirrors.upsert(
        {
          framework: options.framework,
          port: options.port
        }, {
          framework: options.framework,
          port: options.port,
          rootUrl: options.rootUrl,
          mongoUrl: _getMongoUrl(options.framework),
          requestId: options.requestId
        });
    }
  }

  // TODO DOC IT UP
  function _startMeteor (port, settingsPath, procOpts, next) {

    var meteorArgs = [];
    meteorArgs.push(&#x27;--port&#x27;, port);
    meteorArgs.push(&#x27;--settings&#x27;, settingsPath);

    var meteorProc = child_process.execFile(&#x27;meteor&#x27;, meteorArgs, procOpts);
    meteorProc.stdout.pipe(process.stdout);
    meteorProc.stderr.pipe(process.stderr);
    var stopMeteorProc = function () {
      DEBUG &amp;&amp; console.log(&#x27;[velocity] killing mirror&#x27;);
      meteorProc.kill();
    };
    process.on(&#x27;SIGINT&#x27;, stopMeteorProc);

    meteorProc.on(&#x27;exit&#x27;, function (code, signal) {
      DEBUG &amp;&amp; console.log(&#x27;[velocity] Mirror exited with code:&#x27;, code, &#x27; signal:&#x27;, signal);
      process.removeListener(&#x27;SIGINT&#x27;, stopMeteorProc);
      // should we respawn here based on code/signal?
    });

    meteorProc.stdout.setEncoding(&#x27;utf8&#x27;);
    var processMeteorStartup = Meteor.bindEnvironment(function (data) {
      if (data.match(/Started Proxy/i)) {
        console.log(&#x27;[velocity] Mirror started.&#x27;);
        var mirrorPidId = MIRROR_PID_VAR_TEMPLATE.replace(&#x27;@PORT&#x27;, port);
        VelocityVars.upsert({_id: mirrorPidId}, {_id: mirrorPidId, value: meteorProc.pid});
        meteorProc.stdout.removeListener(&#x27;data&#x27;, processMeteorStartup);
        next(null, meteorProc);
      }
      else if (data.match(/Perhaps another Meteor is running/i)) {
        next(new Error(data));
      }
      // TODO there are more scenarios where meteor exists and we need to have those covered
    });
    meteorProc.stdout.on(&#x27;data&#x27;, processMeteorStartup);
  }

  /**
   * Returns true if a mirror with the specified port was started by Velocity and if the pid stored
   * at the time is currently running. This method DOES NOT check the actual connection
   * @param port this is used to look up the PID for the mirror if it was started by Velocity
   * @returns {string} true if the registered mirror process is running
   * @private
   */
  function _isProcessRunningForRegisteredMirrorPid (port) {
    var mirrorPid = MIRROR_PID_VAR_TEMPLATE.replace(&#x27;@PORT&#x27;, port);
    var pid = VelocityVars.findOne(mirrorPid);
    if (!pid) {
      return false;
    }
    DEBUG &amp;&amp; console.log(&#x27;[velocity] Checking if mirror is running with pid&#x27;, pid);
    try {
      process.kill(pid.value, 0);
      DEBUG &amp;&amp; console.log(&#x27;[velocity] process with pid&#x27;, pid, &#x27;is running&#x27;);
      return true;
    } catch (e) {
      DEBUG &amp;&amp; console.log(&#x27;[velocity] process with &#x27;, pid, &#x27;is not running&#x27;);
      return false;
    }
  }

  function _getTestFrameworkNames () {
    return _.pluck(_config, &#x27;name&#x27;);
  }

  /**
   * Returns the MongoDB URL for the given database.
   * @param database
   * @returns {string} MongoDB Url
   * @private
   */
  function _getMongoUrl (database) {
    var mongoLocationParts = url.parse(process.env.MONGO_URL);
    return url.format({
      protocol: mongoLocationParts.protocol,
      slashes: mongoLocationParts.slashes,
      hostname: mongoLocationParts.hostname,
      port: mongoLocationParts.port,
      pathname: &#x27;/&#x27; + database
    });
  }

  /**
   * Return URL for the mirror with the given port.
   * @param port Mirror port
   * @returns {string} Mirror URL
   * @private
   */
  function _getMirrorUrl (port) {
    var rootUrlParts = url.parse(Meteor.absoluteUrl());
    return url.format({
      protocol: rootUrlParts.protocol,
      slashes: rootUrlParts.slashes,
      hostname: rootUrlParts.hostname,
      port: port,
      pathname: rootUrlParts.pathname
    });
  }

  /**
   * Add fixtures to the database.
   * @param fixtureFiles Array with fixture file paths.
   * @private
   */
  function _addFixtures (fixtureFiles) {
    _.each(fixtureFiles, function (fixtureFile) {
      VelocityFixtureFiles.insert({
        _id: fixtureFile,
        absolutePath: fixtureFile
      });
    });
  }

  function _parseTestingFrameworkOptions (name, options) {
    options = options || {};
    _.defaults(options, {
      name: name,
      regex: name + &#x27;\\&#x27; + path.sep + &#x27;.+\\.js$&#x27;
    });

    options._regexp = new RegExp(options.regex);

    return options;
  }

  /**
   * Initialize the directory/file watcher.
   *
   * @method _initWatcher
   * @param {Object} config  See &#x60;registerTestingFramework&#x60;.
   * @private
   */
  function _initWatcher (config) {

    _watcher = chokidar.watch(Velocity.getTestsPath(), {ignored: /[\/\\]\./});

    _watcher.on(&#x27;add&#x27;, Meteor.bindEnvironment(function (filePath) {
      var relativePath,
          targetFramework,
          data;

      filePath = path.normalize(filePath);

      DEBUG &amp;&amp; console.log(&#x27;File added:&#x27;, filePath);

      relativePath = filePath.substring(Velocity.getAppPath().length);
      if (relativePath[0] === path.sep) {
        relativePath = relativePath.substring(1);
      }

      // if this is a fixture file, put it in the fixtures collection
      if (FIXTURE_REG_EXP.test(relativePath)) {
        DEBUG &amp;&amp; console.log(&#x27;[velocity] Copying fixture file&#x27;, relativePath);
        VelocityFixtureFiles.insert({
          _id: filePath,
          absolutePath: filePath,
          lastModified: Date.now()
        });
        return;
      }

      // test against each test framework&#x27;s regexp matcher, use first
      // one that matches
      targetFramework = _.find(config, function (framework) {
        return framework._regexp.test(relativePath);
      });

      if (targetFramework) {
        DEBUG &amp;&amp; console.log(targetFramework.name, &#x27; &lt;= &#x27;, filePath);

        data = {
          _id: filePath,
          name: path.basename(filePath),
          absolutePath: filePath,
          relativePath: relativePath,
          targetFramework: targetFramework.name,
          lastModified: Date.now()
        };

        //DEBUG &amp;&amp; console.log(&#x27;data&#x27;, data);
        VelocityTestFiles.insert(data);
      }
    }));  // end watcher.on &#x27;add&#x27;

    _watcher.on(&#x27;change&#x27;, Meteor.bindEnvironment(function (filePath) {
      DEBUG &amp;&amp; console.log(&#x27;File changed:&#x27;, filePath);

      // Since we key on filePath and we only add files we&#x27;re interested in,
      // we don&#x27;t have to worry about inadvertently updating records for files
      // we don&#x27;t care about.
      VelocityFixtureFiles.update(filePath, {$set: {lastModified: Date.now()}});
      VelocityTestFiles.update(filePath, {$set: {lastModified: Date.now()}});
    }));

    _watcher.on(&#x27;unlink&#x27;, Meteor.bindEnvironment(function (filePath) {
      DEBUG &amp;&amp; console.log(&#x27;File removed:&#x27;, filePath);
      // If we only remove the file, we also need to remove the test results for
      // just that file. This required changing the postResult API and we could
      // do it, but the brute force method of reset() will do the trick until we
      // want to optimize VelocityTestFiles.remove(filePath);
      _reset(config);
    }));

  }  // end _initWatcher

  /**
   * Re-init file watcher and clear all test results.
   *
   * @method _reset
   * @param {Object} config  See &#x60;registerTestingFramework&#x60;.
   * @private
   */
  function _reset (config) {
    if (_watcher) {
      _watcher.close();
    }

    VelocityTestFiles.remove({});
    VelocityFixtureFiles.remove({});
    VelocityFixtureFiles.insert({
      _id: DEFAULT_FIXTURE_PATH,
      absolutePath: DEFAULT_FIXTURE_PATH
    });
    var frameworksWithDisableAutoReset = _(config).where({disableAutoReset: true}).pluck(&#x27;name&#x27;).value();
    DEBUG &amp;&amp; console.log(&#x27;[velocity] not resetting reports and logs for&#x27;, frameworksWithDisableAutoReset);
    VelocityTestReports.remove({framework: {$nin: frameworksWithDisableAutoReset}});
    VelocityLogs.remove({framework: {$nin: frameworksWithDisableAutoReset}});
    VelocityAggregateReports.remove({});
    VelocityAggregateReports.insert({
      name: &#x27;aggregateResult&#x27;,
      result: &#x27;pending&#x27;
    });
    VelocityAggregateReports.insert({
      name: &#x27;aggregateComplete&#x27;,
      result: &#x27;pending&#x27;
    });
    _.forEach(_getTestFrameworkNames(), function (testFramework) {
      VelocityAggregateReports.insert({
        name: testFramework,
        result: &#x27;pending&#x27;
      });
    });
    VelocityMirrors.remove({});

    // Meteor just reloaded us which means we should rsync the app files to the mirror
    _syncMirror();

    _initWatcher(config);
  }

  /**
   * If any one test has failed, mark the aggregate test result as failed.
   *
   * @method _updateAggregateReports
   * @private
   */
  function _updateAggregateReports () {

    var failedResult,
        frameworkResult;

    // if all of our test reports have valid results
    if (!VelocityTestReports.findOne({result: &#x27;&#x27;})) {
      // look through them and see if we find any tests that failed
      failedResult = VelocityTestReports.findOne({result: &#x27;failed&#x27;});

      // if any tests failed, set the framework as failed; otherwise set our framework to passed
      frameworkResult = failedResult ? &#x27;failed&#x27; : &#x27;passed&#x27;;

      // update the global status
      VelocityAggregateReports.update({&#x27;name&#x27;: &#x27;aggregateResult&#x27;}, {$set: {result: frameworkResult}});
    }

    // if all test frameworks have completed, upsert an aggregate completed record
    var completedFrameworksCount = VelocityAggregateReports.find({
      &#x27;name&#x27;: {$in: _getTestFrameworkNames()},
      &#x27;result&#x27;: &#x27;completed&#x27;
    }).count();

    var aggregateComplete = VelocityAggregateReports.findOne({&#x27;name&#x27;: &#x27;aggregateComplete&#x27;});
    if (aggregateComplete) {
      if ((aggregateComplete.result !== &#x27;completed&#x27;) &amp;&amp; (_getTestFrameworkNames().length === completedFrameworksCount)) {
        VelocityAggregateReports.update({&#x27;name&#x27;: &#x27;aggregateComplete&#x27;}, {$set: {&#x27;result&#x27;: &#x27;completed&#x27;}});

        _.each(_postProcessors, function (reporter) {
          reporter();
        });

      }
    }

  }

  /**
   * Creates a physical mirror of the application under .meteor/local/.mirror
   *
   *     - Any files with the pattern tests/.*  are not copied, this stops .report
   *     directory from also being copied.
   *
   *     TODO - Strips out velocity and reporters from the mirror&#x27;s .meteor/packages file
   *
   * @method _syncMirror
   * @param force performs an rsync even if no mirrors have been requested
   * @private
   */
  var _syncing = false;
  function _syncMirror (force) {

    // de-bounce the sync requests which is killing the mirror
    if (_syncing) {
      return;
    }
    _syncing = true;

    // don&#x27;t sync if no mirrors have been requested
    if (!force &amp;&amp; VelocityMirrors.find().count() === 0) {
      return;
    }

    var cmd = new Rsync()
      .shell(&#x27;ssh&#x27;)
      .flags(&#x27;av&#x27;)
      .set(&#x27;delete&#x27;)
      .set(&#x27;q&#x27;)
      .set(&#x27;delay-updates&#x27;)
      .set(&#x27;force&#x27;)
      .exclude(&#x27;/.meteor/local&#x27;)
      .exclude(&#x27;/tests/.*&#x27;)
      .exclude(&#x27;/packages&#x27;)
      // This file is created by velocity:core.
      // It must be excluded to prevent rsync from deleting it.
      .exclude(&#x27;/settings.json&#x27;)
      .source(Velocity.getAppPath() + path.sep)
      .destination(Velocity.getMirrorPath());
    var then = Date.now();
    cmd.execute(Meteor.bindEnvironment(function (error) {

      if (error) {
        console.error(&#x27;[velocity] Error syncing mirror&#x27;, error);
      } else {
        DEBUG &amp;&amp; console.log(&#x27;[velocity] rsync took&#x27;, Date.now() - then);
      }

      _symlinkPackagesDirIfPresent();

      _.each(_preProcessors, function (preProcessor) {
        preProcessor();
      });

      _copyFixtureFilesIntoMirror();

      _syncing = false;

    }));
  }

  // DOC IT UP
  function _copyFixtureFilesIntoMirror () {
    VelocityFixtureFiles.find({}).forEach(function (fixture) {
      var fixtureLocationInMirror = Velocity.getMirrorPath() + path.sep + path.basename(fixture.absolutePath) + path.extname(fixture.absolutePath);
      DEBUG &amp;&amp; console.log(&#x27;[velocity] adding fixture to watch list&#x27;, fixture.absolutePath, &#x27;to mirror&#x27;);
      copyFile(fixture.absolutePath, fixtureLocationInMirror);
    });
  }

  /**
   * Checks if the user has a local packages directory, if so it ensures it&#x27;s symlinked in the mirror.
   * The reason this is needed is because the standard rsync will copy a the packages dir and not respect
   * the symlinks inside it.
   *
   * @method _symlinkPackagesDirIfPresent
   * @private
   */
  function _symlinkPackagesDirIfPresent () {
    var packagesDir = path.join(process.env.PWD, &#x27;packages&#x27;),
        mirrorPackagesDir = path.join(Velocity.getMirrorPath(), &#x27;packages&#x27;);

    if (fs.existsSync(packagesDir) &amp;&amp; !fs.existsSync(mirrorPackagesDir)) {
      fs.symlinkSync(packagesDir, mirrorPackagesDir);
    }

  }

})();

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
